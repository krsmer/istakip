{% extends "base.html" %}

{% block title %}{{ calisan.ad }} {{ calisan.soyad }} - Devam Kaydı{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body text-center">
                <div class="mb-4">
                    <i class="bi bi-person-circle" style="font-size: 5rem; color: #667eea;"></i>
                </div>
                
                <h2 class="mb-3">Merhaba, {{ calisan.ad }}!</h2>
                <p class="text-muted mb-4">İş yerine geldiğinizi kaydetmek için butona tıklayın</p>
                
                <div class="mb-4">
                    <p class="mb-2"><strong>Bugünün Tarihi:</strong></p>
                    <h5 class="text-primary" id="bugun-tarih"></h5>
                    <p class="mb-2 mt-3"><strong>Şu Anki Saat:</strong></p>
                    <h5 class="text-success" id="su-anki-saat"></h5>
                </div>
                
                <div id="location-status" class="alert alert-info mb-3" style="display: none;">
                    <i class="bi bi-geo-alt"></i> <span id="location-message">Konum kontrol ediliyor...</span>
                </div>
                
                <button id="ise-geldi-btn" class="btn btn-primary btn-lg mb-3" 
                        onclick="checkLocationAndSubmit()" disabled>
                    <i class="bi bi-geo-alt-fill me-2"></i>
                    Konum Kontrol Et ve İŞE GELDİM
                </button>
                
                <div id="sonuc-mesaj" class="alert" style="display: none;"></div>
                
                <div class="mt-4">
                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Geri Dön
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Tarih ve saati güncelle
    function saatGuncelle() {
        const simdi = new Date();
        
        // Türkçe tarih formatı
        const tarihOptions = { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            weekday: 'long'
        };
        document.getElementById('bugun-tarih').textContent = 
            simdi.toLocaleDateString('tr-TR', tarihOptions);
        
        // Saat formatı
        document.getElementById('su-anki-saat').textContent = 
            simdi.toLocaleTimeString('tr-TR');
    }
    
    // Her saniye güncelle
    setInterval(saatGuncelle, 1000);
    saatGuncelle(); // İlk yükleme
    
    // GPS Konum Kontrolü
    function checkLocationAndSubmit() {
        const btn = document.getElementById('ise-geldi-btn');
        const locationStatus = document.getElementById('location-status');
        const locationMessage = document.getElementById('location-message');
        
        // Konum kontrol mesajı göster
        locationStatus.style.display = 'block';
        locationStatus.className = 'alert alert-info mb-3';
        locationMessage.textContent = 'GPS konumunuz kontrol ediliyor...';
        
        // Butonu devre dışı bırak
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Konum Kontrol Ediliyor...';
        
        // GPS konum al
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                // Başarılı konum alma
                function(position) {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;
                    
                    // Konum kontrolü için backend'e gönder
                    fetch('/check_location', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            latitude: userLat,
                            longitude: userLon
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Konum onaylandı, işe geldi kaydı yap
                            locationStatus.className = 'alert alert-success mb-3';
                            locationMessage.textContent = data.message;
                            iseGeldiKaydet();
                        } else {
                            // Konum uygun değil
                            locationStatus.className = 'alert alert-danger mb-3';
                            locationMessage.textContent = data.message;
                            btn.disabled = false;
                            btn.innerHTML = '<i class="bi bi-geo-alt-fill me-2"></i> Konum Kontrol Et ve İŞE GELDİM';
                        }
                    })
                    .catch(error => {
                        console.error('Konum kontrol hatası:', error);
                        locationStatus.className = 'alert alert-danger mb-3';
                        locationMessage.textContent = 'Konum kontrolü başarısız oldu!';
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-geo-alt-fill me-2"></i> Konum Kontrol Et ve İŞE GELDİM';
                    });
                },
                // Konum alma hatası
                function(error) {
                    let errorMessage = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Konum erişimi reddedildi. Lütfen tarayıcı ayarlarından konum iznini açın.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Konum bilgisi alınamıyor.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Konum alma işlemi zaman aşımına uğradı.';
                            break;
                        default:
                            errorMessage = 'Bilinmeyen konum hatası oluştu.';
                            break;
                    }
                    
                    locationStatus.className = 'alert alert-danger mb-3';
                    locationMessage.textContent = errorMessage;
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-geo-alt-fill me-2"></i> Konum Kontrol Et ve İŞE GELDİM';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        } else {
            locationStatus.className = 'alert alert-danger mb-3';
            locationMessage.textContent = 'Bu tarayıcı konum hizmetlerini desteklemiyor.';
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-geo-alt-fill me-2"></i> Konum Kontrol Et ve İŞE GELDİM';
        }
    }
    
    // İşe geldi kaydı (konum onaylandıktan sonra)
    function iseGeldiKaydet() {
        const btn = document.getElementById('ise-geldi-btn');
        const sonucMesaj = document.getElementById('sonuc-mesaj');
        
        // Butonu devre dışı bırak
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Kaydediliyor...';
        
        fetch('{{ url_for("ise_geldi", id=calisan.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            sonucMesaj.style.display = 'block';
            
            if (data.success) {
                sonucMesaj.className = 'alert alert-success';
                sonucMesaj.innerHTML = '<i class="bi bi-check-circle"></i> ' + data.message;
                btn.innerHTML = '<i class="bi bi-check"></i> KAYIT TAMAMLANDI';
                btn.className = 'btn btn-outline-success btn-lg mb-3';
            } else {
                sonucMesaj.className = 'alert alert-warning';
                sonucMesaj.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ' + data.message;
                btn.innerHTML = '<i class="bi bi-geo-alt-fill me-2"></i> Konum Kontrol Et ve İŞE GELDİM';
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            sonucMesaj.style.display = 'block';
            sonucMesaj.className = 'alert alert-danger';
            sonucMesaj.innerHTML = '<i class="bi bi-x-circle"></i> Bir hata oluştu, tekrar deneyin.';
            
            btn.innerHTML = '<i class="bi bi-geo-alt-fill me-2"></i> Konum Kontrol Et ve İŞE GELDİM';
            btn.disabled = false;
        });
    }
    
    // Sayfa yüklendiğinde butonu etkinleştir (test için)
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('ise-geldi-btn').disabled = false;
    });
</script>
{% endblock %}
